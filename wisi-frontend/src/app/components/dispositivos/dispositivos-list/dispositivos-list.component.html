<div class="dispositivos-container">
  <div class="header-section">
    <button 
      class="btn-primary" 
      (click)="navigateToCreate()">
      Crear Nuevo Dispositivo
    </button>
  </div>
  
  <div class="list-section" *ngIf="!loading">
    <div class="dispositivos-grid" *ngIf="dispositivos.length > 0">
      <div class="permission-card" *ngFor="let dispositivo of dispositivos">
        <div class="permission-header">
          <div class="permission-info">
            <h3>{{ dispositivo.nombre }}</h3>
            <p class="device-details">
              <strong>Sala:</strong> {{ dispositivo.Sala?.nombre || 'Sin asignar' }}<br>
              <strong>IP Local:</strong> {{ dispositivo.ip_local }}<br>
              <strong *ngIf="dispositivo.ip_remota">IP Remota:</strong> {{ dispositivo.ip_remota }}<br>
              <strong *ngIf="dispositivo.usuario">Usuario:</strong> {{ dispositivo.usuario }}<br>
              <strong *ngIf="dispositivo.clave">Clave:</strong> {{ dispositivo.clave }}<br>
              <strong>Marcaje Inicio:</strong> {{ dispositivo.marcaje_inicio || 'No configurado' }}<br>
              <strong>Marcaje Fin:</strong> {{ dispositivo.marcaje_fin || 'No configurado' }}
            </p>
          </div>
        </div>
        <div class="permission-actions">
          <button 
            class="btn-biometric" 
            (click)="openBiometricModal(dispositivo)">
            Gestión Biométrica
          </button>
          <button 
            class="btn-cron" 
            (click)="openCronModal(dispositivo)">
            CRON
          </button>
          <button 
            class="btn-edit" 
            (click)="navigateToEdit(dispositivo)">
            Editar
          </button>
          <button 
            class="btn-delete" 
            (click)="deleteDispositivo(dispositivo)">
            Eliminar
          </button>
        </div>
      </div>
    </div>
    
    <div *ngIf="dispositivos.length === 0" class="no-devices">
      <p>No hay dispositivos registrados</p>
    </div>
  </div>
  
  <div *ngIf="loading" class="loading">
    <p>Cargando dispositivos...</p>
  </div>
</div>


<!-- Modal Biométrico -->
<div class="modal" [class.show]="showBiometricModal" *ngIf="showBiometricModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Gestión Biométrica - {{ selectedDispositivo?.nombre }}</h2>
      <button type="button" class="btn-close btn-close-red" (click)="closeBiometricModal()"></button>
    </div>
    <div class="modal-body">
      <div class="biometric-info" *ngIf="selectedDispositivo">
        <div class="info-row">
          <strong>IP Remota:</strong> {{ selectedDispositivo.ip_remota }}
        </div>
        <div class="info-row">
          <strong>Usuario:</strong> {{ selectedDispositivo.usuario }}
        </div>
        <div class="info-row">
          <strong>Estado Conexión:</strong> 
          <span [class]="connectionStatus === 'connected' ? 'status-connected' : 'status-disconnected'">
            {{ connectionStatus === 'connected' ? 'Conectado' : 'Desconectado' }}
          </span>
        </div>
        <div class="info-row">
          <strong>Usuarios Registrados:</strong> 
          <span class="user-count">{{ biometricUsers.length }}</span>
        </div>
      </div>

      <div class="biometric-actions-simple">
        <button class="btn-test" (click)="testConnection()" [disabled]="testing">
          {{ testing ? 'Probando...' : 'Probar Conexión' }}
        </button>
        <button class="btn-info" (click)="getUsers()" [disabled]="connectionStatus !== 'connected'">
          Ver Usuarios Registrados
        </button>
        <button class="btn-users" (click)="abrirVistaCrear()" [disabled]="connectionStatus !== 'connected'">
          Agregar Usuario
        </button>
      </div>

      <!-- Vista de Probar Conexión -->
      <div class="biometric-results" *ngIf="currentView === 'test'">
        <div class="test-connection-view">
          <div class="spinner-container" *ngIf="testing">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Probando conexión...</span>
            </div>
            <p>Probando conexión...</p>
          </div>
          <div *ngIf="!testing && connectionStatus === 'connected'" class="connection-success">
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i>
              <strong>¡Conexión exitosa!</strong> El dispositivo está respondiendo correctamente.
            </div>
          </div>
          <div *ngIf="!testing && connectionStatus === 'disconnected'" class="connection-error">
            <div class="alert alert-danger">
              <i class="fas fa-times-circle"></i>
              <strong>Error de conexión</strong> No se pudo conectar con el dispositivo.
            </div>
          </div>
        </div>
      </div>

      <div class="biometric-results" *ngIf="biometricResult && currentView !== 'test'">
        <div class="result-content">
          <div *ngIf="currentView === 'lista' && showUserTable">
            <!-- Spinner de carga para tabla -->
            <div class="spinner-container" *ngIf="loadingUsers">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando usuarios...</span>
              </div>
              <p>Cargando usuarios registrados...</p>
            </div>
            
            <div class="table-responsive" *ngIf="!loadingUsers">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>N°</th>
                    <th>Foto</th>
                    <th>Cédula</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let user of biometricUsers; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>
                      <button class="btn btn-info btn-sm" title="Ver Foto" (click)="verFoto(user)" 
                              style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; min-width: 70px;">
                        <i class="fas fa-eye"></i> Ver
                      </button>
                    </td>
                    <td>{{ user.employeeNo }}</td>
                    <td>{{ user.name }}</td>
                    <td>
                      <button class="btn btn-info btn-sm me-1" title="Editar Usuario" (click)="editarUsuario(user)" [disabled]="updatingUser || deletingUser"
                              style="padding: 6px 12px; border-radius: 4px; font-size: 12px; min-width: 70px;">
                        <span *ngIf="updatingUser" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        <i *ngIf="!updatingUser" class="fas fa-edit"></i> 
                        {{ updatingUser ? 'Editando...' : 'Editar' }}
                      </button>
                      <button class="btn btn-danger btn-sm" title="Eliminar Usuario" (click)="eliminarUsuario(user)" [disabled]="updatingUser || deletingUsers[user.employeeNo]"
                              style="padding: 6px 12px; border-radius: 4px; font-size: 12px; min-width: 70px;">
                        <span *ngIf="deletingUsers[user.employeeNo]" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        <i *ngIf="!deletingUsers[user.employeeNo]" class="fas fa-trash"></i> 
                        {{ deletingUsers[user.employeeNo] ? 'Eliminando...' : 'Eliminar' }}
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div *ngIf="currentView === 'foto'" class="photo-view">
            <div class="photo-header mb-3">
              <button type="button" class="btn btn-secondary btn-sm" (click)="currentView = 'lista'">
                <i class="fas fa-arrow-left"></i> Atrás
              </button>
            </div>
            <div class="photo-container">
              <h5 class="text-center mb-3">Foto del Usuario: {{ editingUser?.userData?.employeeNo || editingUser?.employeeNo }} ({{ editingUser?.name }})</h5>
              <div *ngIf="photoLoading" class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Cargando foto...</p>
              </div>
              
              <div *ngIf="!photoLoading && userPhotoUrl" class="photo-display">
                <img [src]="userPhotoUrl" alt="Foto del usuario" class="user-photo"
                   (error)="onImageError($event)" (load)="onImageLoad($event)">
              </div>
              
              
              <div *ngIf="!photoLoading && (!userPhotoUrl || userPhotoUrl === '') && photoError" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                {{ photoError }}
              </div>
              
              <!-- Input oculto para selección de archivo -->
              <input type="file" id="photoInput" accept="image/*" 
                     (change)="onPhotoSelected($event)" #fileInput 
                     style="display: none;">
              
              <!-- Botones de acción condicionales -->
              <div class="photo-actions mt-3" *ngIf="!photoLoading">
                <div class="d-flex justify-content-center gap-3">
                  <!-- Botón amarillo: Solo aparece si NO hay foto -->
                  <button type="button" class="btn btn-warning" (click)="seleccionarYRegistrarRostro()" 
                          [disabled]="photoLoading" *ngIf="!userPhotoUrl || userPhotoUrl === ''">
                    <span *ngIf="photoLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i *ngIf="!photoLoading" class="fas fa-camera"></i> 
                    {{ photoLoading ? 'Registrando...' : 'Registrar Rostro' }}
                  </button>
                  
                  <!-- Botón rojo: Solo aparece si SÍ hay foto -->
                  <button type="button" class="btn btn-danger" (click)="eliminarSoloFoto()" [disabled]="photoLoading" *ngIf="userPhotoUrl && userPhotoUrl !== ''">
                    <span *ngIf="photoLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i *ngIf="!photoLoading" class="fas fa-trash"></i> 
                    {{ photoLoading ? 'Eliminando...' : 'Eliminar Foto' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div *ngIf="currentView === 'editar'" class="edit-view">
            <div class="photo-header mb-3 d-flex justify-content-center">
              <button type="button" class="btn btn-secondary btn-sm" (click)="currentView = 'lista'">
                <i class="fas fa-arrow-left"></i> Atrás
              </button>
            </div>
            <div class="edit-form">
              <h5>Editar Usuario: {{ editingUser?.userData?.employeeNo || editingUser?.employeeNo }} ({{ editingUser?.name }})</h5>
              <form [formGroup]="editUserForm" (ngSubmit)="onEditUserSubmit()">
                <!-- Todos los campos en una sola fila -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editEmployeeNo" class="form-label">employeeNo</label>
                      <input type="text" class="form-control" id="editEmployeeNo" formControlName="employeeNo" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editName" class="form-label">name</label>
                      <input type="text" class="form-control" id="editName" formControlName="name">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editUserType" class="form-label">userType</label>
                      <input type="text" class="form-control" id="editUserType" formControlName="userType" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editCloseDelayEnabled" class="form-label">closeDelayEnabled</label>
                      <input type="text" class="form-control" id="editCloseDelayEnabled" formControlName="closeDelayEnabled" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editBelongGroup" class="form-label">belongGroup</label>
                      <input type="text" class="form-control" id="editBelongGroup" formControlName="belongGroup" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editPassword" class="form-label">password</label>
                      <input type="text" class="form-control" id="editPassword" formControlName="password" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editDoorRight" class="form-label">doorRight</label>
                      <input type="text" class="form-control" id="editDoorRight" formControlName="doorRight" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editMaxOpenDoorTime" class="form-label">maxOpenDoorTime</label>
                      <input type="text" class="form-control" id="editMaxOpenDoorTime" formControlName="maxOpenDoorTime" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editOpenDoorTime" class="form-label">openDoorTime</label>
                      <input type="text" class="form-control" id="editOpenDoorTime" formControlName="openDoorTime" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editRoomNumber" class="form-label">roomNumber</label>
                      <input type="text" class="form-control" id="editRoomNumber" formControlName="roomNumber" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editFloorNumber" class="form-label">floorNumber</label>
                      <input type="text" class="form-control" id="editFloorNumber" formControlName="floorNumber" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editLocalUIRight" class="form-label">localUIRight</label>
                      <input type="text" class="form-control" id="editLocalUIRight" formControlName="localUIRight" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editUserVerifyMode" class="form-label">userVerifyMode</label>
                      <input type="text" class="form-control" id="editUserVerifyMode" formControlName="userVerifyMode" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editGender" class="form-label">gender</label>
                      <select class="form-control" id="editGender" formControlName="gender">
                        <option value="">Seleccionar género</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editNumOfCard" class="form-label">numOfCard</label>
                      <input type="text" class="form-control" id="editNumOfCard" formControlName="numOfCard" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editNumOfFace" class="form-label">numOfFace</label>
                      <input type="text" class="form-control" id="editNumOfFace" formControlName="numOfFace" >
                    </div>
                  </div>
                </div>
                
                <!-- Sección Valid -->
                <div class="form-section">
                  <h6 class="section-title">Valid</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="editValidEnable" class="form-label">enable</label>
                        <input type="text" class="form-control" id="editValidEnable" formControlName="ValidEnable" >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="editValidBeginTime" class="form-label">beginTime ({{ userBeginTime }})</label>
                        <input type="text" class="form-control" id="editValidBeginTime" formControlName="ValidBeginTime" readonly style="cursor: pointer;">
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="editValidEndTime" class="form-label">endTime ({{ userEndTime }})</label>
                        <input type="text" class="form-control" id="editValidEndTime" formControlName="ValidEndTime" readonly style="cursor: pointer;">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="editValidTimeType" class="form-label">timeType</label>
                        <input type="text" class="form-control" id="editValidTimeType" formControlName="ValidTimeType" >
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Sección RightPlan -->
                <div class="form-section">
                  <h6 class="section-title">RightPlan</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="editRightPlanDoorNo" class="form-label">doorNo</label>
                        <input type="text" class="form-control" id="editRightPlanDoorNo" formControlName="RightPlanDoorNo" >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="editRightPlanTemplateNo" class="form-label">planTemplateNo</label>
                        <input type="text" class="form-control" id="editRightPlanTemplateNo" formControlName="RightPlanTemplateNo" >
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Sección PersonInfoExtends -->
                <div class="form-section">
                  <h6 class="section-title">PersonInfoExtends</h6>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="mb-3">
                        <label for="editPersonInfoExtends" class="form-label">value</label>
                        <input type="text" class="form-control" id="editPersonInfoExtends" formControlName="PersonInfoExtends" placeholder="Ingrese el valor" >
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-primary" (click)="actualizarUsuario()" [disabled]="updatingUser">
                    <span *ngIf="updatingUser" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i *ngIf="!updatingUser" class="fas fa-save"></i> 
                    {{ updatingUser ? 'Actualizando...' : 'Actualizar Usuario' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
          
          <div *ngIf="currentView === 'crear'" class="edit-view">
            <div class="photo-header mb-3 d-flex justify-content-center">
              <button type="button" class="btn btn-secondary btn-sm" (click)="currentView = 'lista'">
                <i class="fas fa-arrow-left"></i> Atrás
              </button>
            </div>
            <div class="edit-form">
              <h5>Crear Usuario</h5>
              <form [formGroup]="createUserForm" (ngSubmit)="onCreateUserSubmit()">
                <!-- Todos los campos en una sola fila -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createEmployeeNo" class="form-label">employeeNo</label>
                      <input type="text" class="form-control" id="createEmployeeNo" formControlName="employeeNo" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createName" class="form-label">name</label>
                      <input type="text" class="form-control" id="createName" formControlName="name">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createUserType" class="form-label">userType</label>
                      <input type="text" class="form-control" id="createUserType" formControlName="userType" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createCloseDelayEnabled" class="form-label">closeDelayEnabled</label>
                      <input type="text" class="form-control" id="createCloseDelayEnabled" formControlName="closeDelayEnabled" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createBelongGroup" class="form-label">belongGroup</label>
                      <input type="text" class="form-control" id="createBelongGroup" formControlName="belongGroup" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createPassword" class="form-label">password</label>
                      <input type="text" class="form-control" id="createPassword" formControlName="password" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createDoorRight" class="form-label">doorRight</label>
                      <input type="text" class="form-control" id="createDoorRight" formControlName="doorRight" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createMaxOpenDoorTime" class="form-label">maxOpenDoorTime</label>
                      <input type="text" class="form-control" id="createMaxOpenDoorTime" formControlName="maxOpenDoorTime" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createOpenDoorTime" class="form-label">openDoorTime</label>
                      <input type="text" class="form-control" id="createOpenDoorTime" formControlName="openDoorTime" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createRoomNumber" class="form-label">roomNumber</label>
                      <input type="text" class="form-control" id="createRoomNumber" formControlName="roomNumber" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createFloorNumber" class="form-label">floorNumber</label>
                      <input type="text" class="form-control" id="createFloorNumber" formControlName="floorNumber" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createLocalUIRight" class="form-label">localUIRight</label>
                      <input type="text" class="form-control" id="createLocalUIRight" formControlName="localUIRight" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createUserVerifyMode" class="form-label">userVerifyMode</label>
                      <input type="text" class="form-control" id="createUserVerifyMode" formControlName="userVerifyMode" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createGender" class="form-label">gender</label>
                      <select class="form-control" id="createGender" formControlName="gender">
                        <option value="">Seleccionar género</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createNumOfCard" class="form-label">numOfCard</label>
                      <input type="text" class="form-control" id="createNumOfCard" formControlName="numOfCard" >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="createNumOfFace" class="form-label">numOfFace</label>
                      <input type="text" class="form-control" id="createNumOfFace" formControlName="numOfFace" >
                    </div>
                  </div>
                </div>
                
                <!-- Sección Valid -->
                <div class="form-section">
                  <h6 class="section-title">Valid</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="createValidEnable" class="form-label">enable</label>
                        <input type="text" class="form-control" id="createValidEnable" formControlName="ValidEnable" >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="createValidBeginTime" class="form-label">beginTime</label>
                        <input type="text" class="form-control" id="createValidBeginTime" formControlName="ValidBeginTime" readonly>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="createValidEndTime" class="form-label">endTime</label>
                        <input type="text" class="form-control" id="createValidEndTime" formControlName="ValidEndTime" readonly>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="createValidTimeType" class="form-label">timeType</label>
                        <input type="text" class="form-control" id="createValidTimeType" formControlName="ValidTimeType" >
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Sección RightPlan -->
                <div class="form-section">
                  <h6 class="section-title">RightPlan</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="createRightPlanDoorNo" class="form-label">doorNo</label>
                        <input type="text" class="form-control" id="createRightPlanDoorNo" formControlName="RightPlanDoorNo" >
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="createRightPlanTemplateNo" class="form-label">planTemplateNo</label>
                        <input type="text" class="form-control" id="createRightPlanTemplateNo" formControlName="RightPlanTemplateNo" >
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Sección PersonInfoExtends -->
                <div class="form-section">
                  <h6 class="section-title">PersonInfoExtends</h6>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="mb-3">
                        <label for="createPersonInfoExtends" class="form-label">value</label>
                        <input type="text" class="form-control" id="createPersonInfoExtends" formControlName="PersonInfoExtends" placeholder="Ingrese el valor" >
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-success" (click)="crearUsuario()" [disabled]="creatingUser">
                    <span *ngIf="creatingUser" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i *ngIf="!creatingUser" class="fas fa-user-plus"></i> 
                    {{ creatingUser ? 'Creando...' : 'Crear Usuario' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeBiometricModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal para agregar usuario -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">
          <i class="fas fa-user-plus"></i> Agregar Usuario
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="addUserForm" (ngSubmit)="onAddUserSubmit()">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="employeeNo" class="form-label">Employee</label>
                <input type="text" class="form-control" id="employeeNo" formControlName="employeeNo" 
                       placeholder="Ej: 100" required>
                <div class="invalid-feedback" *ngIf="addUserForm.get('employeeNo')?.invalid && addUserForm.get('employeeNo')?.touched">
                  El employee es requerido
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="name" class="form-label">Nombre Completo</label>
                <input type="text" class="form-control" id="name" formControlName="name" 
                       placeholder="Ej: Juan Pérez" required>
                <div class="invalid-feedback" *ngIf="addUserForm.get('name')?.invalid && addUserForm.get('name')?.touched">
                  El nombre es requerido
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="gender" class="form-label">Género</label>
                <select class="form-select" id="gender" formControlName="gender" required>
                  <option value="">Seleccionar género</option>
                  <option value="male">male</option>
                  <option value="female">female</option>
                </select>
                <div class="invalid-feedback" *ngIf="addUserForm.get('gender')?.invalid && addUserForm.get('gender')?.touched">
                  El género es requerido
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="addUserType" class="form-label">Tipo de Usuario</label>
                <select class="form-select" id="addUserType" formControlName="userType" required>
                  <option value="">Seleccionar tipo</option>
                  <option value="normal">Normal</option>
                  <option value="admin">Administrador</option>
                </select>
                <div class="invalid-feedback" *ngIf="addUserForm.get('userType')?.invalid && addUserForm.get('userType')?.touched">
                  El tipo de usuario es requerido
                </div>
              </div>
            </div>
          </div>

          <!-- Campos predefinidos (deshabilitados) -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="addUserTypeDisabled" class="form-label">userType</label>
                <input type="text" class="form-control" id="addUserTypeDisabled" formControlName="userType" 
                       value="normal" >
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="doorRight" class="form-label">doorRight</label>
                <input type="text" class="form-control" id="doorRight" formControlName="doorRight" 
                       value="1" >
              </div>
            </div>
          </div>

          <!-- Campos de tiempo (editables) -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="addBeginTime" class="form-label">beginTime</label>
                <input type="text" class="form-control" id="addBeginTime" formControlName="ValidBeginTime" 
                       readonly>
                <div class="invalid-feedback" *ngIf="addUserForm.get('ValidBeginTime')?.invalid && addUserForm.get('ValidBeginTime')?.touched">
                  La fecha de inicio es requerida
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="addEndTime" class="form-label">endTime</label>
                <input type="text" class="form-control" id="addEndTime" formControlName="ValidEndTime" 
                       readonly>
                <div class="invalid-feedback" *ngIf="addUserForm.get('ValidEndTime')?.invalid && addUserForm.get('ValidEndTime')?.touched">
                  La fecha de fin es requerida
                </div>
              </div>
            </div>
          </div>

          <!-- Sección de foto -->
          <div class="mb-3">
            <label for="photo" class="form-label">Foto del Usuario</label>
            <div class="row">
              <div class="col-md-6">
                <input type="file" class="form-control" id="photo" accept="image/*" 
                       (change)="onPhotoSelected($event)" #fileInput>
                <div class="form-text">Selecciona una imagen (JPG, PNG, GIF)</div>
              </div>
              <div class="col-md-6">
                <div *ngIf="selectedPhoto" class="text-center">
                  <img [src]="selectedPhoto" alt="Vista previa" class="img-thumbnail" 
                       style="max-width: 100px; max-height: 100px;">
                  <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" (click)="removePhoto()">
                      <i class="fas fa-trash"></i> Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Validación de formulario -->
          <div *ngIf="addUserForm.invalid && addUserForm.touched" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Por favor, completa todos los campos requeridos.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-warning" (click)="onAddUserSubmit()" 
                [disabled]="addUserForm.invalid || isAddingUser">
          <i class="fas fa-user-plus" *ngIf="!isAddingUser"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="isAddingUser"></i>
          {{ isAddingUser ? 'Agregando...' : 'Agregar Usuario' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal CRON -->
<div class="modal" [class.show]="showCronModal" *ngIf="showCronModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Configuración CRON - {{ selectedDispositivo?.nombre }}</h2>
      <button type="button" class="btn-close btn-close-red" (click)="closeCronModal()"></button>
    </div>
    <div class="modal-body">
      <div class="cron-config">
        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="cronActivo"
              [checked]="cronActivo">
            <span class="checkmark"></span>
            Activar CRON
          </label>
        </div>
        
        <div class="form-group">
          <label for="cronTiempo">Intervalo de tiempo:</label>
          <select 
            id="cronTiempo" 
            [(ngModel)]="cronTiempo"
            class="form-control">
            <option value="1m">1 minuto</option>
            <option value="5m">5 minutos</option>
            <option value="10m">10 minutos</option>
            <option value="30m">30 minutos</option>
            <option value="1h">1 hora</option>
            <option value="6h">6 horas</option>
            <option value="12h">12 horas</option>
            <option value="24h">24 horas</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeCronModal()">
        Cancelar
      </button>
      <button type="button" class="btn btn-primary" (click)="saveCronConfig()">
        Guardar Configuración
      </button>
    </div>
  </div>
</div>